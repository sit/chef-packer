node.default[:packer][:url_base] = 'https://dl.bintray.com/mitchellh/packer'
node.default[:packer][:version] = '0.7.5'
node.default[:packer][:arch] = kernel['machine'] =~ /x86_64/ ? 'amd64' : '386'

# Transform raw output of the bintray checksum list into a Hash[filename, checksum].
# https://dl.bintray.com/mitchellh/packer/${VERSION}_SHA256SUMS?direct
node.default[:packer][:raw_checksums] = <<-EOF
    72d57fe6a6ec2660dda2aed73198a4c4d9152037831d6aa44c64a28307c299c7  packer_0.7.5_darwin_386.zip
    c0e149c4515fe548c1daeafabec3b4a091f2aa0c6936723382b3f6fe5a617880  packer_0.7.5_darwin_amd64.zip
    6bce28c51a1862cbc3071421546620fb27007732f7a8470054e7267ca3521b95  packer_0.7.5_freebsd_386.zip
    508293b60f525c44560ca569db5b63b6f92294f655c61b076243a98a0ea75604  packer_0.7.5_freebsd_amd64.zip
    1cef5f1875a19b9c46daca5f36739bf2e9c9d68b1f27319abdc36c02837ac662  packer_0.7.5_freebsd_arm.zip
    6a6ee79d51909f04f734c15a0e12ebcaba3f2cf4d449906f6a186490774262f9  packer_0.7.5_linux_386.zip
    8fab291c8cc988bd0004195677924ab6846aee5800b6c8696d71d33456701ef6  packer_0.7.5_linux_amd64.zip
    8a7d63f0a9282f7b0a833a8455d37f5916d5a9200c17c83627922e08ed9ec2ca  packer_0.7.5_linux_arm.zip
    986d3b038f54ef86de313b10d45248c78159ebf5850615ab326d6e57229086a6  packer_0.7.5_openbsd_386.zip
    c11a67715de000de6742ebe7fb7187ba1db08333ec3941111a72672f0eb27509  packer_0.7.5_openbsd_amd64.zip
    99b879f491df08fa217193edea0b777341c73d4a145f2329b5c795d821258536  packer_0.7.5_windows_386.zip
    1dccdb825bbdd3487747771f58cecb5cbd0a73d44b52958f0d09ac9086b861b9  packer_0.7.5_windows_amd64.zip
EOF
node.default[:packer][:checksums] = Hash[
    node[:packer][:raw_checksums].split("\n").collect { |s| s.split.reverse }
]

#
# Since 0.7.0, the URL format has been changed to:
# - https://dl.bintray.com/mitchellh/packer/packer_${VERSION}_${OS}_${ARCH}.zip
# Older versions (0.6.1 and below) use:
# - https://dl.bintray.com/mitchellh/packer/packer_${VERSION}_${OS}_${ARCH}.zip
#
# Make sure you change `node[:packer][:filename_format]` to
# '%{version}_%{os}_%{arch}.zip' when you need to stick with the old.
#
node.default[:packer][:filename_format] = 'packer_%{version}_%{os}_%{arch}.zip'
filename = node[:packer][:filename_format] % { :version => node[:packer][:version], :os => node[:os], :arch => node[:packer][:arch] }

node.default[:packer][:filename] = filename
node.default[:packer][:checksum] = node[:packer][:checksums][filename]
